name: Runner System Info Check

on:
  workflow_dispatch:  # 手动触发
    inputs:
      runner_type:
        description: '选择 Runner 类型'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ubuntu-latest
          - ubuntu-22.04
          - ubuntu-20.04
          - windows-latest
          - macos-latest
      include_detailed_info:
        description: '包含详细信息'
        required: false
        default: true
        type: boolean

jobs:
  check-system-info:
    runs-on: ${{ github.event.inputs.runner_type == 'all' && 'ubuntu-latest' || github.event.inputs.runner_type }}
    
    # 如果选择 all，使用矩阵并行检查所有 Ubuntu 版本
    strategy:
      matrix:
        include:
          - ${{ github.event.inputs.runner_type == 'all' && 'ubuntu-20.04' || 'skip' }}
          - ${{ github.event.inputs.runner_type == 'all' && 'ubuntu-22.04' || 'skip' }}
          - ${{ github.event.inputs.runner_type == 'all' && 'ubuntu-latest' || 'skip' }}
        exclude:
          - skip
    
    steps:
    - name: 1. 系统基本信息
      run: |
        echo "=== 系统基本信息 ==="
        echo "Runner OS: $(uname -s)"
        echo "Kernel版本: $(uname -r)"
        echo "架构: $(uname -m)"
        echo "主机名: $(hostname)"
        echo "GitHub Runner版本: ${{ runner.version }}"
        echo "工作目录: ${{ runner.workspace }}"
        echo "作业ID: ${{ github.run_id }}"
        echo "触发者: ${{ github.actor }}"
    
    - name: 2. CPU 信息
      run: |
        echo ""
        echo "=== CPU 信息 ==="
        echo "CPU型号:"
        cat /proc/cpuinfo | grep 'model name' | head -1 | cut -d ':' -f2 | xargs
        echo "CPU核心数: $(nproc)"
        echo "CPU线程数: $(grep -c processor /proc/cpuinfo)"
        echo "CPU架构: $(arch)"
        echo "CPU频率:"
        cat /proc/cpuinfo | grep 'cpu MHz' | head -1 | cut -d ':' -f2 | xargs
        echo "CPU缓存:"
        lscpu | grep -E 'L[1-3] cache'
    
    - name: 3. 内存信息
      run: |
        echo ""
        echo "=== 内存信息 ==="
        echo "总内存:"
        free -h | grep Mem | awk '{print $2}'
        echo "可用内存:"
        free -h | grep Mem | awk '{print $7}'
        echo "内存使用率:"
        free | grep Mem | awk '{printf "%.1f%%\n", $3/$2 * 100.0}'
        echo ""
        echo "详细内存信息:"
        cat /proc/meminfo | grep -E 'MemTotal|MemFree|MemAvailable|SwapTotal|SwapFree'
    
    - name: 4. 硬盘信息
      run: |
        echo ""
        echo "=== 硬盘信息 ==="
        echo "磁盘分区信息:"
        df -h
        echo ""
        echo "根目录使用情况:"
        df -h / | tail -1
        echo ""
        echo "工作目录使用情况:"
        df -h ${{ runner.workspace }} 2>/dev/null || echo "工作目录不存在"
        echo ""
        echo "GitHub Actions 目录大小:"
        du -sh /home/runner/work 2>/dev/null || echo "目录不存在"
        du -sh /home/runner/runners 2>/dev/null || echo "目录不存在"
    
    - name: 5. 网络信息
      run: |
        echo ""
        echo "=== 网络信息 ==="
        echo "IP地址:"
        ip addr show | grep -E 'inet (192|172|10)' | awk '{print $2}' | head -5
        echo "公网IP:"
        curl -s ifconfig.me 2>/dev/null || echo "无法获取公网IP"
        echo "DNS配置:"
        cat /etc/resolv.conf 2>/dev/null | grep nameserver
    
    - name: 6. 系统负载
      run: |
        echo ""
        echo "=== 系统负载 ==="
        echo "当前负载:"
        uptime
        echo ""
        echo "进程数:"
        ps aux | wc -l
        echo "运行时间:"
        uptime -p
    
    - name: 7. 预装软件信息
      if: ${{ github.event.inputs.include_detailed_info }}
      run: |
        echo ""
        echo "=== 预装软件信息 ==="
        echo "Git版本: $(git --version 2>/dev/null || echo '未安装')"
        echo "Node.js版本: $(node --version 2>/dev/null || echo '未安装')"
        echo "Python版本: $(python3 --version 2>/dev/null || echo '未安装')"
        echo "Java版本: $(java -version 2>&1 | head -1 2>/dev/null || echo '未安装')"
        echo "Docker版本: $(docker --version 2>/dev/null || echo '未安装')"
        echo "Docker Compose版本: $(docker-compose --version 2>/dev/null || echo '未安装')"
    
    - name: 8. 环境变量信息
      if: ${{ github.event.inputs.include_detailed_info }}
      run: |
        echo ""
        echo "=== 重要环境变量 ==="
        echo "RUNNER_OS: $RUNNER_OS"
        echo "RUNNER_ARCH: $RUNNER_ARCH"
        echo "RUNNER_TEMP: $RUNNER_TEMP"
        echo "RUNNER_TOOL_CACHE: $RUNNER_TOOL_CACHE"
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
        echo "GITHUB_ACTION_PATH: $GITHUB_ACTION_PATH"
    
    - name: 9. 硬件详细信息
      if: ${{ github.event.inputs.include_detailed_info }}
      run: |
        echo ""
        echo "=== 硬件详细信息 ==="
        echo "PCI设备:"
        lspci 2>/dev/null | head -20 || echo "lspci 不可用"
        echo ""
        echo "USB设备:"
        lsusb 2>/dev/null | head -10 || echo "lsusb 不可用"
        echo ""
        echo "磁盘型号:"
        lsblk -o NAME,SIZE,TYPE,MODEL 2>/dev/null || echo "lsblk 不可用"
    
    - name: 10. 生成摘要报告
      run: |
        echo ""
        echo "=== 系统信息摘要 ==="
        echo "系统: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'=' -f2 | tr -d '\"')"
        echo "内核: $(uname -r)"
      
