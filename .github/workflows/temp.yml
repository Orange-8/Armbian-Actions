name: Runner System Info Check

on:
  workflow_dispatch:  # 手动触发
    inputs:
      runner_type:
        description: '选择 Runner 类型'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - ubuntu-22.04
          - ubuntu-20.04
          - windows-latest
          - macos-latest
          - all-ubuntu
      include_detailed_info:
        description: '包含详细信息'
        required: false
        default: true
        type: boolean

jobs:
  check-single-runner:
    if: github.event.inputs.runner_type != 'all-ubuntu'
    runs-on: ${{ github.event.inputs.runner_type }}
    
    steps:
    - name: 1. 系统基本信息
      run: |
        echo "=== 系统基本信息 ==="
        echo "Runner OS: ${{ runner.os }}"
        echo "Runner 版本: ${{ runner.version }}"
        echo "工作目录: ${{ runner.workspace }}"
        echo "作业ID: ${{ github.run_id }}"
        echo "触发者: ${{ github.actor }}"
        
        # Linux 系统信息
        if [ "${{ runner.os }}" == "Linux" ]; then
          echo "系统发行版:"
          cat /etc/os-release | grep PRETTY_NAME
          echo "内核版本: $(uname -r)"
          echo "架构: $(uname -m)"
          echo "主机名: $(hostname)"
        fi
        
        # Windows 系统信息
        if [ "${{ runner.os }}" == "Windows" ]; then
          echo "Windows 系统信息:"
          systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
        fi
        
        # macOS 系统信息
        if [ "${{ runner.os }}" == "macOS" ]; then
          echo "macOS 系统信息:"
          sw_vers
          echo "主机名: $(hostname)"
        fi
    
    - name: 2. CPU 信息 (Linux/macOS)
      if: runner.os == 'Linux' || runner.os == 'macOS'
      run: |
        echo ""
        echo "=== CPU 信息 ==="
        
        if [ "${{ runner.os }}" == "Linux" ]; then
          echo "CPU型号:"
          grep 'model name' /proc/cpuinfo | head -1 | cut -d ':' -f2 | xargs
          echo "CPU核心数: $(nproc)"
          echo "CPU线程数: $(grep -c processor /proc/cpuinfo)"
          echo "CPU架构: $(arch)"
          echo "L1/L2/L3缓存:"
          lscpu | grep -E 'L[1-3] cache' || true
        fi
        
        if [ "${{ runner.os }}" == "macOS" ]; then
          echo "CPU型号:"
          sysctl -n machdep.cpu.brand_string
          echo "CPU核心数: $(sysctl -n hw.ncpu)"
          echo "CPU类型: $(sysctl -n hw.cputype)"
          echo "CPU子类型: $(sysctl -n hw.cpusubtype)"
        fi
    
    - name: 2. CPU 信息 (Windows)
      if: runner.os == 'Windows'
      run: |
        echo ""
        echo "=== CPU 信息 ==="
        Get-WmiObject Win32_Processor | Select-Object Name, NumberOfCores, NumberOfLogicalProcessors, MaxClockSpeed | Format-List
    
    - name: 3. 内存信息 (Linux/macOS)
      if: runner.os == 'Linux' || runner.os == 'macOS'
      run: |
        echo ""
        echo "=== 内存信息 ==="
        
        if [ "${{ runner.os }}" == "Linux" ]; then
          echo "总内存:"
          free -h | grep Mem | awk '{print $2}'
          echo "可用内存:"
          free -h | grep Mem | awk '{print $7}'
          echo "内存使用率:"
          free | grep Mem | awk '{printf "%.1f%%\n", $3/$2 * 100.0}'
          echo ""
          echo "Swap信息:"
          swapon --show
        fi
        
        if [ "${{ runner.os }}" == "macOS" ]; then
          echo "内存信息:"
          sysctl -n hw.memsize | awk '{printf "总内存: %.2f GB\n", $1/1024/1024/1024}'
          vm_stat | grep "Pages free" | awk '{print $3}' | awk '{printf "可用内存: %.2f GB\n", $1*4096/1024/1024/1024}'
        fi
    
    - name: 3. 内存信息 (Windows)
      if: runner.os == 'Windows'
      run: |
        echo ""
        echo "=== 内存信息 ==="
        $totalMemory = (Get-WmiObject Win32_ComputerSystem).TotalPhysicalMemory
        $totalGB = [math]::Round($totalMemory / 1GB, 2)
        echo "总内存: ${totalGB} GB"
        
        $os = Get-WmiObject Win32_OperatingSystem
        $freeGB = [math]::Round($os.FreePhysicalMemory / 1MB, 2)
        $usedPercent = [math]::Round(($os.TotalVisibleMemorySize - $os.FreePhysicalMemory) / $os.TotalVisibleMemorySize * 100, 2)
        echo "可用内存: ${freeGB} GB"
        echo "内存使用率: ${usedPercent}%"
    
    - name: 4. 硬盘信息 (Linux/macOS)
      if: runner.os == 'Linux' || runner.os == 'macOS'
      run: |
        echo ""
        echo "=== 硬盘信息 ==="
        echo "磁盘分区信息:"
        df -h
        
        echo ""
        echo "根目录使用情况:"
        df -h / | tail -1
        
        echo ""
        echo "工作目录使用情况:"
        df -h ${{ runner.workspace }} 2>/dev/null || echo "无法获取工作目录信息"
    
    - name: 4. 硬盘信息 (Windows)
      if: runner.os == 'Windows'
      run: |
        echo ""
        echo "=== 硬盘信息 ==="
        Get-PSDrive -PSProvider FileSystem | Select-Object Name, Used, Free, @{Name="UsedGB";Expression={[math]::Round($_.Used/1GB,2)}}, @{Name="FreeGB";Expression={[math]::Round($_.Free/1GB,2)}} | Format-Table
    
    - name: 5. 系统负载信息
      run: |
        echo ""
        echo "=== 系统负载信息 ==="
        
        if [ "${{ runner.os }}" == "Linux" ]; then
          echo "当前负载:"
          uptime
          echo "运行时间:"
          uptime -p
          echo "进程数: $(ps aux | wc -l)"
        elif [ "${{ runner.os }}" == "macOS" ]; then
          echo "当前负载:"
          uptime
          echo "运行时间:"
          uptime | awk '{for(i=3;i<=NF;i++) printf $i" "}'
          echo ""
          echo "进程数: $(ps aux | wc -l)"
        else
          echo "系统启动时间:"
          systeminfo | findstr "启动时间"
          echo "进程数:"
          (Get-Process).Count
        fi
    
    - name: 6. 预装软件信息
      if: ${{ github.event.inputs.include_detailed_info }}
      run: |
        echo ""
        echo "=== 预装软件信息 ==="
        
        # 检查常用工具
        tools=("git" "node" "python3" "java" "docker" "docker-compose" "npm" "yarn" "pip3")
        
        for tool in "${tools[@]}"; do
          if command -v $tool &> /dev/null; then
            version_output=$($tool --version 2>&1 | head -1)
            echo "$tool: $version_output"
          else
            echo "$tool: 未安装"
          fi
        done

  check-all-ubuntu:
    if: github.event.inputs.runner_type == 'all-ubuntu'
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, ubuntu-20.04]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: 1. 系统基本信息
      run: |
        echo "=== ${{ matrix.os }} 系统信息 ==="
        echo "Runner: ${{ matrix.os }}"
        echo "作业ID: ${{ github.run_id }}"
        
        cat /etc/os-release | grep PRETTY_NAME
        echo "内核版本: $(uname -r)"
        echo "架构: $(uname -m)"
        echo "主机名: $(hostname)"
    
    - name: 2. CPU 和内存信息
      run: |
        echo ""
        echo "=== CPU 和内存信息 ==="
        echo "CPU核心数: $(nproc)"
        echo "CPU线程数: $(grep -c processor /proc/cpuinfo)"
        echo "CPU型号:"
        grep 'model name' /proc/cpuinfo | head -1 | cut -d ':' -f2 | xargs
        
        echo ""
        echo "内存信息:"
        echo "总内存: $(free -h | grep Mem | awk '{print $2}')"
        echo "可用内存: $(free -h | grep Mem | awk '{print $7}')"
        echo "内存使用率: $(free | grep Mem | awk '{printf "%.1f%%\n", $3/$2 * 100.0}')"
    
    - name: 3. 硬盘信息
      run: |
        echo ""
        echo "=== 硬盘信息 ==="
        echo "根目录使用情况:"
        df -h / | tail -1
        echo ""
        echo "总磁盘信息:"
        df -h
    
    - name: 4. 系统负载
      run: |
        echo ""
        echo "=== 系统负载 ==="
        echo "当前负载:"
        uptime
        echo "运行时间:"
        uptime -p
        echo "进程数: $(ps aux | wc -l)"
    
    - name: 5. 生成摘要报告
      run: |
        echo ""
        echo "=== ${{ matrix.os }} 摘要 ==="
        echo "系统: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'=' -f2 | tr -d '\"')"
        echo "CPU核心: $(nproc)"
        echo "内存总量: $(free -h | grep Mem | awk '{print $2}')"
        echo "磁盘总量: $(df -h / | tail -1 | awk '{print $2}')"
        echo "可用磁盘: $(df -h / | tail -1 | awk '{print $4}')"
        echo "负载: $(uptime | awk -F'load average:' '{print $2}' | xargs)"

  summary-report:
    needs: 
      - check-single-runner
      - check-all-ubuntu
    runs-on: ubuntu-latest
    
    steps:
    - name: 生成最终报告
      run: |
        echo "# GitHub Actions Runner 规格比较报告"
        echo ""
        echo "生成时间: $(date)"
        echo "工作流ID: ${{ github.run_id }}"
        echo ""
        echo "## GitHub 托管 Runner 官方标准规格"
        echo ""
        echo "| Runner 类型 | 内存 | 存储 | CPU | 网络 |"
        echo "|------------|------|------|-----|------|"
        echo "| Ubuntu (所有版本) | 7 GB | 14 GB | 2核心 | 10 Gbps |"
        echo "| Windows Server | 7 GB | 14 GB | 2核心 | 10 Gbps |"
        echo "| macOS | 14 GB | 14 GB | 3核心 | 10 Gbps |"
        echo ""
        echo "## 检测结果说明"
        echo ""
        echo "1. 所有托管 Runner 都使用相同的虚拟机规格模板"
        echo "2. 实际可用资源会略低于标称值（系统开销）"
        echo "3. 自托管 Runner 的规格由提供者决定"
        echo "4. GitHub 可能会根据区域和负载动态调整资源"
        echo ""
        echo "## 使用建议"
        echo ""
        echo "1. **内存敏感任务**：优先选择 macOS Runner（14GB内存）"
        echo "2. **跨平台测试**：使用矩阵策略并行测试"
        echo "3. **大型构建**：考虑使用自托管 Runner 或优化缓存"
        echo "4. **网络敏感**：所有 Runner 都有 10Gbps 网络"
        
    - name: 上传报告
      uses: actions/upload-artifact@v4
      with:
        name: runner-spec-report
        path: |
          # 这里可以添加需要保存的文件
        if-no-files-found: warn
